name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Grant script permissions
        run: |
          chmod +x scripts/scan-sbom.sh
          chmod +x tests/test-scan.sh
      
      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          VERBOSE=true ./tests/test-scan.sh
        continue-on-error: false
      
      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: tests/test-workspace/failed-tests-logs/
          retention-days: 7
      
      - name: Upload generated SBOMs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-sbom-files
          path: tests/test-workspace/*_bom.json
          retention-days: 7
          if-no-files-found: ignore
  
  lint:
    name: Lint Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Lint Bash scripts
        run: |
          echo "Linting shell scripts..."
          echo "Checking scripts/scan-sbom.sh..."
          shellcheck scripts/scan-sbom.sh || true
          echo ""
          echo "Checking docker/entrypoint.sh..."
          shellcheck docker/entrypoint.sh || true
          echo ""
          echo "Checking tests/test-scan.sh..."
          shellcheck tests/test-scan.sh || true
          echo ""
          echo "✅ Shellcheck completed (warnings are informational)"
      
      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: docker/Dockerfile
          failure-threshold: error
        continue-on-error: true
  
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check required documentation
        run: |
          echo "Checking documentation files..."
          
          # Main README (Required)
          if [ -f README.md ]; then
            echo "✓ README.md found"
          else
            echo "❌ README.md not found"
            exit 1
          fi
          
          # Check if docs directory exists
          if [ ! -d docs ]; then
            echo "⚠️ docs/ directory not found - skipping doc checks"
            exit 0
          fi
          
          # User documentation (if exists)
          for doc in getting-started.md usage-guide.md examples-guide.md; do
            if [ -f "docs/$doc" ]; then
              echo "✓ docs/$doc found"
            else
              echo "⚠️ docs/$doc not found (optional)"
            fi
          done
          
          # Docker documentation
          if [ -f docker/README.md ]; then
            echo "✓ docker/README.md found"
          else
            echo "⚠️ docker/README.md not found (optional)"
          fi
          
          echo ""
          echo "✅ Documentation check completed"
      
      - name: Check Markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          config-file: '.github/markdown-link-check-config.json'
          use-quiet-mode: 'yes'
        continue-on-error: true
  
  validate-examples:
    name: Validate Examples
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        example: [java-maven, java-gradle, nodejs, python, go, ruby, php, rust, dotnet]
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Validate ${{ matrix.example }} structure
        run: |
          echo "Validating ${{ matrix.example }} example..."
          
          if [ ! -d "examples/${{ matrix.example }}" ]; then
            echo "❌ examples/${{ matrix.example }} directory not found"
            exit 1
          fi
          
          cd examples/${{ matrix.example }}
          
          # Check README exists
          if [ ! -f README.md ]; then
            echo "❌ README.md not found in ${{ matrix.example }}"
            exit 1
          fi
          echo "✓ README.md found"
          
          # Check manifest file based on example type
          case "${{ matrix.example }}" in
            java-maven)
              if [ -f pom.xml ] && [ -d src ]; then
                echo "✓ Maven project structure valid"
              else
                echo "❌ Missing pom.xml or src/"
                exit 1
              fi
              ;;
            java-gradle)
              if [ -f build.gradle ]; then
                echo "✓ Gradle project structure valid"
              else
                echo "❌ Missing build.gradle"
                exit 1
              fi
              ;;
            nodejs)
              if [ -f package.json ]; then
                echo "✓ Node.js project structure valid"
              else
                echo "❌ Missing package.json"
                exit 1
              fi
              ;;
            python)
              if [ -f requirements.txt ]; then
                echo "✓ Python project structure valid"
              else
                echo "❌ Missing requirements.txt"
                exit 1
              fi
              ;;
            go)
              if [ -f go.mod ]; then
                echo "✓ Go project structure valid"
              else
                echo "❌ Missing go.mod"
                exit 1
              fi
              ;;
            ruby)
              if [ -f Gemfile ]; then
                echo "✓ Ruby project structure valid"
              else
                echo "❌ Missing Gemfile"
                exit 1
              fi
              ;;
            php)
              if [ -f composer.json ]; then
                echo "✓ PHP project structure valid"
              else
                echo "❌ Missing composer.json"
                exit 1
              fi
              ;;
            rust)
              if [ -f Cargo.toml ]; then
                echo "✓ Rust project structure valid"
              else
                echo "❌ Missing Cargo.toml"
                exit 1
              fi
              ;;
            dotnet)
              if ls *.csproj > /dev/null 2>&1; then
                echo "✓ .NET project structure valid"
              else
                echo "❌ Missing .csproj file"
                exit 1
              fi
              ;;
          esac
          
          echo "✅ ${{ matrix.example }} validation passed"
  
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [test, lint, validate-docs, validate-examples]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## CI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Script Linting | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.validate-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Examples | ${{ needs.validate-examples.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Only fail if critical tests failed
          if [ "${{ needs.test.result }}" == "failure" ]; then
            echo "❌ Integration tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ needs.validate-examples.result }}" == "failure" ]; then
            echo "❌ Example validation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ Critical checks passed" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.lint.result }}" == "failure" ] || [ "${{ needs.validate-docs.result }}" == "failure" ]; then
              echo "⚠️ Some non-critical checks have warnings" >> $GITHUB_STEP_SUMMARY
            fi
          fi
